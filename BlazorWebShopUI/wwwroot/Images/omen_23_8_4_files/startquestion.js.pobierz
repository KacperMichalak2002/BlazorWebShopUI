var __defProp=Object.defineProperty,__defNormalProp=(e,t,i)=>t in e?__defProp(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,__publicField=(e,t,i)=>(__defNormalProp(e,"symbol"!=typeof t?t+"":t,i),i);(function(){"use strict";class Browser{constructor(e){__publicField(this,"topDomain"),this.window=e}getUrl(){return this.window.location.href}getReferrer(){return this.window.document.referrer}getLang(){return this.window.navigator.language.slice(0,2)}getScrollState(){const e=this.window.scrollY+this.window.innerHeight;return{pixels:e,percents:e/this.window.document.body.offsetHeight*100}}getDeviceType(){return isMobile(this.window.navigator.userAgent)||window.innerWidth<=480?"mobile":"desktop"}getOperatingSystem(){if(this.window.navigator.platform.match(/win/i))return"windows";if(this.window.navigator.platform.match(/mac/i))return"macos";return this.window.navigator.platform.match(/linux/i)?"linux":"unknown"}hasScrollbar(){return this.window.innerWidth>this.window.document.documentElement.clientWidth}getCookies(){return parseCookies(this.window.document.cookie)}addMouseoutListener(e){this.window.document.addEventListener("mouseout",e)}addScrollListener(e){this.window.document.addEventListener("scroll",e)}openInNewTab(e){const t=this.window.document.createElement("a");t.target="_blank",t.href=e,t.textContent="Redirecting...",document.body.appendChild(t),t.click(),document.body.removeChild(t)}setCookieInTopDomain(e,t,i){this.window.document.cookie=`${e}=${t};domain=${this.getTopDomain()};expires=${getFutureDateInUtc(i)};path=/`}removeCookie(e){this.window.document.cookie=`${e}=;domain=.${this.getTopDomain()};expires=Thu, 01 Jan 1970 00:00:01 GMT;path=/`}getTopDomain(){return this.topDomain||(this.topDomain=getTopDomain(this.window)),this.topDomain}}const getTopDomain=e=>{const{document:t}=e,i="startquestion-detect-top-level-domain",n=`${i}=cookie`,s=t.location.hostname.split(".");if(1===s.length)return s[0];let r;for(let a=s.length-2;a>=0;a--)if(r=s.slice(a).join("."),t.cookie=`${n};domain=.${r};path=/`,t.cookie.indexOf(n)>-1)return t.cookie=`${i}=;domain=.${r};expires=Thu, 01 Jan 1970 00:00:01 GMT;path=/`,r;return""},getFutureDateInUtc=e=>{const t=new Date;return t.setTime(t.getTime()+24*e*60*60*1e3),t.toUTCString()},parseCookies=e=>e.split("; ").reduce(((e,t)=>{const[i,n]=t.split("=");return e[i]=n,e}),{}),isMobile=e=>/(tablet|ipad|playbook|silk)|(android(?!.*mobi))/i.test(e)||/Mobile|iP(hone|od)|Android|BlackBerry|IEMobile|Kindle|Silk-Accelerated|(hpw|web)OS|Opera M(obi|ini)/.test(e);let configuration;const setConfiguration$1=e=>{configuration=e},getConfiguration$1=()=>configuration,getEntranceStyles=()=>`\n  ${getKeyframes()}\n  ${getClasses()}\n`,getClasses=()=>"\n.sq-entrance-center-left {\n  -webkit-animation: sq-scale-in-left 0.35s cubic-bezier(0.250, 0.460, 0.450, 0.940) both;\n  animation: sq-scale-in-left 0.35s cubic-bezier(0.250, 0.460, 0.450, 0.940) both;\n}\n\n.sq-entrance-center-right {\n  -webkit-animation: sq-scale-in-right 0.35s cubic-bezier(0.250, 0.460, 0.450, 0.940) both;\n  animation: sq-scale-in-right 0.35s cubic-bezier(0.250, 0.460, 0.450, 0.940) both;\n}\n\n.sq-entrance-top-center {\n  -webkit-animation: sq-scale-in-top 0.35s cubic-bezier(0.250, 0.460, 0.450, 0.940) both;\n  animation: sq-scale-in-top 0.35s cubic-bezier(0.250, 0.460, 0.450, 0.940) both;\n}\n\n.sq-entrance-bottom-center {\n  -webkit-animation: sq-scale-in-bottom 0.35s cubic-bezier(0.250, 0.460, 0.450, 0.940) both;\n  animation: sq-scale-in-bottom 0.35s cubic-bezier(0.250, 0.460, 0.450, 0.940) both;\n}\n\n.sq-entrance-top-left {\n  -webkit-animation: sq-scale-in-top-left 0.35s cubic-bezier(0.250, 0.460, 0.450, 0.940) both;\n  animation: sq-scale-in-top-left 0.35s cubic-bezier(0.250, 0.460, 0.450, 0.940) both;\n}\n\n.sq-entrance-top-right {\n  -webkit-animation: sq-scale-in-top-right 0.35s cubic-bezier(0.250, 0.460, 0.450, 0.940) both;\n  animation: sq-scale-in-top-right 0.35s cubic-bezier(0.250, 0.460, 0.450, 0.940) both;\n}\n\n.sq-entrance-bottom-left {\n  -webkit-animation: sq-scale-in-bottom-left 0.35s cubic-bezier(0.250, 0.460, 0.450, 0.940) both;\n  animation: sq-scale-in-bottom-left 0.35s cubic-bezier(0.250, 0.460, 0.450, 0.940) both;\n}\n\n.sq-entrance-bottom-right {\n  -webkit-animation: sq-scale-in-bottom-right 0.35s cubic-bezier(0.250, 0.460, 0.450, 0.940) both;\n  animation: sq-scale-in-bottom-right 0.35s cubic-bezier(0.250, 0.460, 0.450, 0.940) both;\n}\n\n.sq-entrance-center-center {\n  -webkit-animation: sq-fade-in 0.35s cubic-bezier(0.390, 0.575, 0.565, 1.000) both;\n  animation: sq-fade-in 0.35s cubic-bezier(0.390, 0.575, 0.565, 1.000) both;\n}\n",getKeyframes=()=>"\n@-webkit-keyframes sq-scale-in-left {\n  0% {\n    -webkit-transform: scale(0);\n            transform: scale(0);\n    -webkit-transform-origin: 0% 50%;\n            transform-origin: 0% 50%;\n    opacity: 1;\n  }\n  100% {\n    -webkit-transform: scale(1);\n            transform: scale(1);\n    -webkit-transform-origin: 0% 50%;\n            transform-origin: 0% 50%;\n    opacity: 1;\n  }\n}\n\n@keyframes sq-scale-in-left {\n  0% {\n    -webkit-transform: scale(0);\n            transform: scale(0);\n    -webkit-transform-origin: 0% 50%;\n            transform-origin: 0% 50%;\n    opacity: 1;\n  }\n  100% {\n    -webkit-transform: scale(1);\n            transform: scale(1);\n    -webkit-transform-origin: 0% 50%;\n            transform-origin: 0% 50%;\n    opacity: 1;\n  }\n}\n\n@-webkit-keyframes sq-scale-in-right {\n  0% {\n    -webkit-transform: scale(0);\n            transform: scale(0);\n    -webkit-transform-origin: 100% 50%;\n            transform-origin: 100% 50%;\n    opacity: 1;\n  }\n  100% {\n    -webkit-transform: scale(1);\n            transform: scale(1);\n    -webkit-transform-origin: 100% 50%;\n            transform-origin: 100% 50%;\n    opacity: 1;\n  }\n}\n\n@keyframes sq-scale-in-right {\n  0% {\n    -webkit-transform: scale(0);\n            transform: scale(0);\n    -webkit-transform-origin: 100% 50%;\n            transform-origin: 100% 50%;\n    opacity: 1;\n  }\n  100% {\n    -webkit-transform: scale(1);\n            transform: scale(1);\n    -webkit-transform-origin: 100% 50%;\n            transform-origin: 100% 50%;\n    opacity: 1;\n  }\n}\n\n@-webkit-keyframes sq-scale-in-top {\n  0% {\n    -webkit-transform: scale(0);\n            transform: scale(0);\n    -webkit-transform-origin: 50% 0%;\n            transform-origin: 50% 0%;\n    opacity: 1;\n  }\n  100% {\n    -webkit-transform: scale(1);\n            transform: scale(1);\n    -webkit-transform-origin: 50% 0%;\n            transform-origin: 50% 0%;\n    opacity: 1;\n  }\n}\n\n@keyframes sq-scale-in-top {\n  0% {\n    -webkit-transform: scale(0);\n            transform: scale(0);\n    -webkit-transform-origin: 50% 0%;\n            transform-origin: 50% 0%;\n    opacity: 1;\n  }\n  100% {\n    -webkit-transform: scale(1);\n            transform: scale(1);\n    -webkit-transform-origin: 50% 0%;\n            transform-origin: 50% 0%;\n    opacity: 1;\n  }\n}\n\n@-webkit-keyframes sq-scale-in-bottom {\n  0% {\n    -webkit-transform: scale(0);\n            transform: scale(0);\n    -webkit-transform-origin: 50% 100%;\n            transform-origin: 50% 100%;\n    opacity: 1;\n  }\n  100% {\n    -webkit-transform: scale(1);\n            transform: scale(1);\n    -webkit-transform-origin: 50% 100%;\n            transform-origin: 50% 100%;\n    opacity: 1;\n  }\n}\n\n@keyframes sq-scale-in-bottom {\n  0% {\n    -webkit-transform: scale(0);\n            transform: scale(0);\n    -webkit-transform-origin: 50% 100%;\n            transform-origin: 50% 100%;\n    opacity: 1;\n  }\n  100% {\n    -webkit-transform: scale(1);\n            transform: scale(1);\n    -webkit-transform-origin: 50% 100%;\n            transform-origin: 50% 100%;\n    opacity: 1;\n  }\n}\n\n@-webkit-keyframes sq-scale-in-top-left {\n  0% {\n    -webkit-transform: scale(0);\n            transform: scale(0);\n    -webkit-transform-origin: 0% 0%;\n            transform-origin: 0% 0%;\n    opacity: 0;\n  }\n  100% {\n    -webkit-transform: scale(1);\n            transform: scale(1);\n    -webkit-transform-origin: 0% 0%;\n            transform-origin: 0% 0%;\n    opacity: 1;\n  }\n}\n\n@keyframes sq-scale-in-top-left {\n  0% {\n    -webkit-transform: scale(0);\n            transform: scale(0);\n    -webkit-transform-origin: 0% 0%;\n            transform-origin: 0% 0%;\n    opacity: 0;\n  }\n  100% {\n    -webkit-transform: scale(1);\n            transform: scale(1);\n    -webkit-transform-origin: 0% 0%;\n            transform-origin: 0% 0%;\n    opacity: 1;\n  }\n}\n\n@-webkit-keyframes sq-scale-in-top-right {\n  0% {\n    -webkit-transform: scale(0);\n            transform: scale(0);\n    -webkit-transform-origin: 100% 0%;\n            transform-origin: 100% 0%;\n    opacity: 0;\n  }\n  100% {\n    -webkit-transform: scale(1);\n            transform: scale(1);\n    -webkit-transform-origin: 100% 0%;\n            transform-origin: 100% 0%;\n    opacity: 1;\n  }\n}\n\n@keyframes sq-scale-in-top-right {\n  0% {\n    -webkit-transform: scale(0);\n            transform: scale(0);\n    -webkit-transform-origin: 100% 0%;\n            transform-origin: 100% 0%;\n    opacity: 0;\n  }\n  100% {\n    -webkit-transform: scale(1);\n            transform: scale(1);\n    -webkit-transform-origin: 100% 0%;\n            transform-origin: 100% 0%;\n    opacity: 1;\n  }\n}\n\n@-webkit-keyframes sq-scale-in-bottom-left {\n  0% {\n    -webkit-transform: scale(0);\n            transform: scale(0);\n    -webkit-transform-origin: 0% 100%;\n            transform-origin: 0% 100%;\n    opacity: 0;\n  }\n  100% {\n    -webkit-transform: scale(1);\n            transform: scale(1);\n    -webkit-transform-origin: 0% 100%;\n            transform-origin: 0% 100%;\n    opacity: 1;\n  }\n}\n\n@keyframes sq-scale-in-bottom-left {\n  0% {\n    -webkit-transform: scale(0);\n            transform: scale(0);\n    -webkit-transform-origin: 0% 100%;\n            transform-origin: 0% 100%;\n    opacity: 0;\n  }\n  100% {\n    -webkit-transform: scale(1);\n            transform: scale(1);\n    -webkit-transform-origin: 0% 100%;\n            transform-origin: 0% 100%;\n    opacity: 1;\n  }\n}\n\n@-webkit-keyframes sq-scale-in-bottom-right {\n  0% {\n    -webkit-transform: scale(0);\n            transform: scale(0);\n    -webkit-transform-origin: 100% 100%;\n            transform-origin: 100% 100%;\n    opacity: 0;\n  }\n  100% {\n    -webkit-transform: scale(1);\n            transform: scale(1);\n    -webkit-transform-origin: 100% 100%;\n            transform-origin: 100% 100%;\n    opacity: 1;\n  }\n}\n\n@keyframes sq-scale-in-bottom-right {\n  0% {\n    -webkit-transform: scale(0);\n            transform: scale(0);\n    -webkit-transform-origin: 100% 100%;\n            transform-origin: 100% 100%;\n    opacity: 0;\n  }\n  100% {\n    -webkit-transform: scale(1);\n            transform: scale(1);\n    -webkit-transform-origin: 100% 100%;\n            transform-origin: 100% 100%;\n    opacity: 1;\n  }\n}\n\n@-webkit-keyframes sq-fade-in {\n  0% {\n    -webkit-transform: scale(0.9);\n            transform: scale(0.9);\n    opacity: 0;\n  }\n  100% {\n    -webkit-transform: scale(1);\n            transform: scale(1);\n    opacity: 1;\n  }\n}\n\n@keyframes sq-fade-in {\n  0% {\n    -webkit-transform: scale(0.9);\n            transform: scale(0.9);\n    opacity: 0;\n  }\n  100% {\n    -webkit-transform: scale(1);\n            transform: scale(1);\n    opacity: 1;\n  }\n}\n",createApplicationContainer=()=>{const e=document.createElement("div");return e.id="startquestion-container",e.append(getStyles()),e},getStyles=()=>{const e=document.createElement("style"),t=getConfiguration$1();return t&&t.nonce&&e.setAttribute("nonce",t.nonce),e.innerHTML=`\n    ${getEntranceStyles()}\n  `,e},showElement=e=>{e.style.opacity="1",e.style.visibility="visible"},animateEntrance=(e,t)=>{e.setAttribute("class",""),e.classList.add(`sq-entrance-${t}`)},hideElement=e=>{e.style.opacity="0",e.style.visibility="hidden"};class Widget{constructor(e,t){__publicField(this,"container"),__publicField(this,"iframe"),__publicField(this,"callbacks",{onOpen:()=>{},onClose:()=>{}}),this.id=e,this.createElements(e),this.callbacks={...this.callbacks,...t}}createElements(e){const t=document.createElement("div"),i=document.createElement("iframe");i.style.width="100%",i.style.height="100%",i.style.border="none",t.style.position="fixed",t.style.overflow="hidden",t.style.opacity="0",t.style.visibility="hidden",t.style.border="none",t.style.boxShadow="rgb(0 0 0 / 15%) 0px 10px 40px 0px",t.style.zIndex="99999999999",t.setAttribute("data-id",`${e}`),t.append(i),this.iframe=i,this.container=t}injectTemplate(e){this.iframe.contentDocument.write(e)}open(){showElement(this.container),animateEntrance(this.container,this.getAnimationAttribute()),this.callbacks.onOpen()}close(e=!1){hideElement(this.container),this.callbacks.onClose(),e&&this.send({type:"RESET",payload:{}})}destroy(){this.close(),this.container.remove()}updateAppearance(e){const{appearance:t,animation:i}=e;t.top&&(this.container.style.top=t.top),t.left&&(this.container.style.left=t.left),t.bottom&&(this.container.style.bottom=t.bottom),t.right&&(this.container.style.right=t.right),t.borderRadius&&(this.container.style.borderRadius=t.borderRadius),t.transition&&(this.container.style.transition=t.transition),t.maxWidth&&(this.container.style.width=t.maxWidth),this.container.setAttribute("data-animation",i),e.modeChange&&animateEntrance(this.container,this.getAnimationAttribute())}getAnimationAttribute(){return this.container.getAttribute("data-animation")}getId(){return this.id}getContainer(){return this.container}send(e){this.iframe.contentWindow.postMessage(e)}}class WidgetManager{constructor(e){__publicField(this,"widgets",[]),this.container=e}init(e){e.forEach((e=>{if(this.isWidgetInitialized(e.id))return void this.open(e.id);const t=new Widget(e.id,e.callbacks);this.widgets.push(t),this.container.append(t.getContainer()),t.injectTemplate(e.template)}))}isWidgetInitialized(e){return this.widgets.some((t=>t.getId()===e))}find(e){return this.widgets.find((t=>t.getId()===e))}updateAppearance(e,t){var i;null==(i=this.find(e))||i.updateAppearance(t)}close(e,t=!1){var i;null==(i=this.find(e))||i.close(t)}open(e){var t;null==(t=this.find(e))||t.open()}destroy(e){this.widgets=this.widgets.filter((t=>t.getId()!==e||(t.destroy(),!1)))}send(e,t){var i;null==(i=this.find(e))||i.send(t)}sendToAll(e,t){this.widgets.forEach((i=>{t.includes(i.getId())||this.send(i.getId(),e)}))}}const services={};let appContainer;const getService=(e,t)=>(services[e]||(services[e]=t()),services[e]),getBrowser=()=>getService("Browser",(()=>new Browser(window))),getAppContainer=()=>(appContainer||(appContainer=createApplicationContainer()),appContainer),getWidgetManager=()=>getService("WidgetManager",(()=>new WidgetManager(getAppContainer()))),refresh=e=>{getWidgetManager().send(e,{type:"REFRESH",payload:{}})},getTemplate=(e,t)=>{const{nonce:i}=t,n=i?` nonce=${i}`:"";return`\n  <html lang='${t.lang}'>\n    <head></head>\n    <body>\n      <script ${n}>\n        var AppConfiguration = ${JSON.stringify(t)};\n        var __webpack_nonce__ = ${JSON.stringify(i)};\n      <\/script>\n      <script ${n} type='text/javascript' charset='utf-8' src='${e}?t=${Math.random()}'><\/script>\n    </body>\n  </html>\n`};let embeddableConfiguration={key:void 0,scrollDelay:200,locationChangeDelay:2e3,timeDelay:5e3,cookieChangeDelay:5e3,expandSessionIntervalInSeconds:5,sessionKey:"session",sessionTimeInMinutes:60,storagePrefix:"startquestion",apiUrl:void 0,widgetAppUrl:void 0,storageType:"both",installationVerificationHosts:[],storageCookieLifeTimeInDays:180};const setConfiguration=e=>{embeddableConfiguration={...embeddableConfiguration,...e}},getConfiguration=()=>embeddableConfiguration;class Subject{constructor(){__publicField(this,"observers",[])}notify(e){this.observers.forEach((t=>{t(e)}))}subscribe(e){this.observers.push(e)}}const findCodeRules=e=>e.settings.rules.reduce(((e,t)=>"aggregated"===t.type?[...e,...findCodeRules(t)]:"codeReturnsTrue"===t.type?[...e,t]:e),[]),getInitialBoolean=(e,t)=>{switch(e){case"and":return!0;case"or":return 0===t;default:throw new Error("Operator is not supported")}},calculateLogicValue=(e,t,i)=>{switch(e){case"and":return t&&i;case"or":return t||i;default:throw new Error("Operator is not supported")}},convertToNumber=e=>Number.isNaN(Number(e))?void 0:Number(e),DAYS_TIMESTAMP_MULTIPLIER=864e5,validateRule=(e,t)=>getValidateForRule(e,t)(),getValidateForRule=(e,t)=>{switch(e.type){case"aggregated":return()=>validateAggregated(e,t);case"url":return()=>validateStringComparison(e.settings.type,t.browserState.url,e.settings.value);case"previousPageUrl":return()=>validateStringComparison(e.settings.type,t.browserState.previousPageUrl,e.settings.value);case"scroll":return()=>validateScroll(e,t.browserState.scroll);case"time":return()=>t.browserState.singlePageTime>=e.settings.value;case"totalTime":return()=>t.browserState.pageTime>=e.settings.value;case"cookie":return()=>validateCookie(e,t.browserState.cookies);case"quit":return()=>t.browserState.exitIntent;case"viewsLimitNotReached":{const i=t.widgetState.filled?e.settings.forFilled:e.settings.forNotFilled;return()=>e.settings.value>t.widgetState.views||validateRecuringPeriod(t,i)}case"notFilled":return()=>validateFilled(t)||validateRecuringPeriod(t,e.settings.forFilled);case"notClosed":return()=>validateClosed(t);case"numberOfPages":return()=>e.settings.value<=t.browserState.numberOfVisitedPages;case"codeReturnsTrue":return()=>{var i;return null==(i=t.customIntervalState)?void 0:i.some((t=>t.ruleId===e.id&&t.fulfilled))};case"device":return()=>e.settings.type===t.browserState.device;case"attribute":return()=>validateAttributes(e,null==t?void 0:t.attributes);default:return()=>!1}},validateFilled=e=>!(e.browserState.cookies.widget_surveyFilled===e.widgetState.id.toString())&&!e.widgetState.filled,validateRecuringPeriod=(e,t)=>{if(!t.isActive)return!1;return Number(e.widgetState.lastViewDate)+Number(t.value*DAYS_TIMESTAMP_MULTIPLIER)<=+new Date},validateClosed=e=>!(e.browserState.cookies.widget_surveyFilled===e.widgetState.id.toString())&&!e.widgetState.closed,validateAggregated=(e,t)=>e.settings.rules.reduce(((i,n)=>calculateLogicValue(e.settings.operator,i,validateRule(n,t))),getInitialBoolean(e.settings.operator,e.settings.rules.length)),validateStringComparison=(e,t,i)=>{switch(e){case"contain":return t.includes(i);case"equal":return t===i;case"notContain":return!t.includes(i);case"notEqual":return t!==i;default:throw new Error("Type is not supported")}},validateScroll=(e,t)=>{if("percent"===e.settings.unit)return t.percents>=e.settings.value;if("pixel"===e.settings.unit)return t.pixels>=e.settings.value;throw new Error("Unit is not supported")},validateCookie=(e,t)=>!!t[e.settings.name]&&validateStringComparison(e.settings.type,t[e.settings.name],e.settings.value),validateAttributes=(e,t)=>{const i=t[e.settings.name],n=e.settings.value;return void 0!==i&&void 0!==n&&validateStringIgnoreCaseComparison(e.settings.type,i.toString(),n.toString())},validateStringIgnoreCaseComparison=(e,t,i)=>validateStringComparison(e,t.toLowerCase(),i.toLowerCase());class DisplayRulesGuard extends Subject{constructor(e,t,i,n){super(),__publicField(this,"state"),__publicField(this,"widgets"),__publicField(this,"processedWidgets",[]),this.browserWatcher=e,this.customIntervalWatcher=t,this.attributesWatcher=i,this.widgetStorage=n}watch(e){this.widgets=e,this.subscribeProviders(),this.setupCustomIntervals()}subscribeProviders(){this.browserWatcher.subscribe((e=>{this.updateState({browserState:e})})),this.customIntervalWatcher.subscribe((e=>{this.updateState({customIntervalState:e})})),this.attributesWatcher.subscribe((()=>{this.updateState({})}))}setupCustomIntervals(){this.widgets.forEach((widget=>{const codeRules=findCodeRules(widget.displayRule);codeRules.forEach((rule=>{this.customIntervalWatcher.addInterval({widgetId:widget.id,ruleId:rule.id,interval:1e3*rule.settings.interval,func:eval(`(${rule.settings.code})`)})}))}))}updateState(e){this.state={...this.state,...e},this.emitResultIfSome(this.validateAll())}emitResultIfSome(e){0!==e.length&&this.notify(e)}validateAll(){return this.widgets.reduce(((e,t)=>[...e,...this.validate(t)]),[])}validate(e){if(this.processedWidgets.includes(e.id))return[];const t=validateRule(e.displayRule,{...this.state,attributes:this.attributesWatcher.getState(e.id),widgetState:this.widgetStorage.getState(e.id)});return t&&this.processedWidgets.push(e.id),t?[e.id]:[]}}class CustomIntervalWatcher extends Subject{constructor(){super(...arguments),__publicField(this,"states",[])}addInterval(e){this.states.push({widgetId:e.widgetId,ruleId:e.ruleId,fulfilled:!1,timer:setInterval((()=>e.func(this.getCompleteCallback(e))),e.interval)})}getCompleteCallback(e){return(t,i)=>{i&&i.forceClearInterval?this.clearInterval(e.ruleId):t&&(this.clearInterval(e.ruleId),this.fulfillRule(e.ruleId))}}fulfillRule(e){const t=this.states.map((t=>({...t,fulfilled:t.ruleId===e||t.fulfilled})));this.notify(t)}clearInterval(e){clearInterval(this.states.find((t=>t.ruleId===e)).timer)}}class MessagesHandler{constructor(e,t,i){this.widgetManager=e,this.widgetStorage=t,this.browser=i}setup(){window.addEventListener("message",(e=>{e.data.id&&!this.widgetManager.isWidgetInitialized(e.data.id)||("WIDGET_LOADED"===e.data.type&&(this.widgetManager.open(e.data.id),this.widgetStorage.addView(e.data.id)),"WIDGET_CLOSED"===e.data.type&&(this.widgetManager.close(e.data.id),this.widgetStorage.updateState(e.data.id,{closed:!0})),"WIDGET_FILLED"===e.data.type&&(setTimeout((()=>this.widgetManager.close(e.data.id)),5e3),this.widgetStorage.updateState(e.data.id,{filled:!0})),"APPEARANCE_CHANGED"===e.data.type&&this.widgetManager.updateAppearance(e.data.id,e.data.payload),"REDIRECT_WWW"===e.data.type&&this.browser.openInNewTab(e.data.payload.url))}))}}class AttributesHandler{constructor(e,t){this.attributesWatcher=e,this.widgetManager=t}setup(){this.subscribeProviders()}subscribeProviders(){this.attributesWatcher.subscribe((e=>{this.notifyWidgetAboutAttributes(e)}))}notifyWidgetAboutAttributes(e){const t=e.widgetsAttributes.map((e=>e.widgetId));this.widgetManager.sendToAll({type:"SET_ATTRIBUTES",payload:e.commonAttributes},t),e.widgetsAttributes.forEach((e=>{this.widgetManager.send(e.widgetId,{type:"SET_ATTRIBUTES",payload:e.attributes})}))}}class StateSubject extends Subject{constructor(){super(...arguments),__publicField(this,"state")}updateState(e){this.state={...this.state,...e},this.notify(this.state)}subscribe(e){super.subscribe(e),e(this.state)}}class BrowserWatcher extends StateSubject{constructor(e,t,i){super(),this.userSession=e,this.browser=t,this.bindManager=i,this.updateState(this.getInitialState()),this.bindTriggers()}getInitialState(){return{url:this.browser.getUrl(),previousPageUrl:this.browser.getReferrer(),scroll:this.browser.getScrollState(),singlePageTime:0,pageTime:this.userSession.getData().pageTime,numberOfVisitedPages:this.userSession.increaseVisitedPages(),device:this.browser.getDeviceType(),cookies:this.browser.getCookies(),exitIntent:!1}}bindTriggers(){this.bindManager.bindLocationChange(((e,t)=>{this.updateState({url:e,previousPageUrl:t,scroll:{pixels:0,percents:0},singlePageTime:0,numberOfVisitedPages:this.userSession.increaseVisitedPages()})})),this.bindManager.bindScrollChange((e=>{e.pixels>this.state.scroll.pixels&&this.updateState({scroll:e})})),this.bindManager.bindTimeChange((e=>{const t=this.state.singlePageTime+e,i=this.state.pageTime+e;this.userSession.updateData({pageTime:i}),this.updateState({singlePageTime:t,pageTime:i})})),this.bindManager.bindCookieChange((e=>this.updateState({cookies:e}))),this.bindManager.bindExitIntent((e=>{this.state.exitIntent!==e&&this.updateState({exitIntent:e})}))}}class AttributesWatcher extends Subject{constructor(){super(...arguments),__publicField(this,"state",{commonAttributes:{},widgetsAttributes:[]})}updateState(e){if(!e.widgetId||Array.isArray(e.widgetId)&&0===e.widgetId.length)this.state.commonAttributes=e.attributes;else{[].concat(e.widgetId).forEach((t=>{this.state.widgetsAttributes=[...this.state.widgetsAttributes.filter((e=>e.widgetId!==t)),{widgetId:t,attributes:e.attributes}]}))}this.notify(this.state)}getState(e){var t;let i=(null==(t=this.state.widgetsAttributes.find((t=>t.widgetId===e)))?void 0:t.attributes)||{};return 0===Object.keys(i).length&&(i=this.state.commonAttributes),i}}function debounce(e,t,i){let n;return function(...s){const r=this,a=i&&!n;clearTimeout(n),n=setTimeout((function(){n=void 0,i||e.apply(r,s)}),t),a&&e.apply(r,s)}}class BindManager{constructor(e,t){this.browser=e,this.configuration=t}bindLocationChange(e){let t,i=this.browser.getUrl();setInterval((()=>{t=this.browser.getUrl(),i!==t&&(e(t,i),i=t)}),this.configuration.locationChangeDelay)}bindScrollChange(e){const t=debounce((()=>{e(this.browser.getScrollState())}),this.configuration.scrollDelay,!1);this.browser.addScrollListener(t)}bindTimeChange(e){const t=this.configuration.timeDelay/1e3;setInterval((()=>{e(t)}),this.configuration.timeDelay)}bindCookieChange(e){let t=this.browser.getCookies();setInterval((()=>{const i=this.browser.getCookies();JSON.stringify(t)!==JSON.stringify(i)&&(t=i,e(i))}),this.configuration.cookieChangeDelay)}bindExitIntent(e){this.browser.addMouseoutListener((t=>{e(t.clientY<=10)}))}}class AggregatedStorage{constructor(e,t){this.browserStorage=e,this.cookieStorage=t}getItem(e){const t=this.cookieStorage.getItem(e);if(null!==t)return t;const i=this.browserStorage.getItem(e);return null!==i&&this.cookieStorage.setItem(e,i),i}removeItem(e){this.browserStorage.removeItem(e),this.cookieStorage.removeItem(e)}setItem(e,t){this.browserStorage.setItem(e,t),this.cookieStorage.setItem(e,t)}}class BrowserStorage{constructor(e=(()=>window.localStorage)){__publicField(this,"storage"),this.storage=e()}getItem(e){return this.storage.getItem(e)}removeItem(e){this.storage.removeItem(e)}setItem(e,t){this.storage.setItem(e,t)}}class CookieStorage{constructor(e,t){this.browser=e,this.lifeTimeInDays=t}getItem(e){const t=this.browser.getCookies();return t[e]?decodeURIComponent(t[e]):null}removeItem(e){this.browser.removeCookie(e)}setItem(e,t){const i=encodeURIComponent(t);this.browser.setCookieInTopDomain(e,i,this.lifeTimeInDays)}}class Session{constructor(e,t){__publicField(this,"sessionTimer"),this.configuration=e,this.storage=t,this.startSession()}getData(){return this.getState().data}updateData(e){this.updateState({data:{...this.getState().data,...e}})}startSession(){this.sessionTimer&&(clearInterval(this.sessionTimer),this.storage.removeItem(this.configuration.sessionKey)),this.sessionTimer=setInterval((()=>this.expandSession()),1e3*this.configuration.expandSessionIntervalInSeconds)}getState(){const e=this.storage.getItem(this.configuration.sessionKey);return e&&e.expirationDate>=+new Date?e:{expirationDate:this.getNewExpirationDate(),data:this.getInitialData()}}updateState(e){this.storage.setItem(this.configuration.sessionKey,{...this.getState(),...e})}expandSession(){this.updateState({expirationDate:this.getNewExpirationDate()})}getNewExpirationDate(){return+new Date+60*this.configuration.sessionTimeInMinutes*1e3}}class UserSession extends Session{getInitialData(){return{pageTime:0,numberOfVisitedPages:0}}increaseVisitedPages(){const e=this.getData().numberOfVisitedPages+1;return this.updateData({numberOfVisitedPages:e}),e}}class StorageWrapper{constructor(e=null,t){__publicField(this,"storage"),this.prefix=e,this.storage=t}prefixKey(e){return this.prefix?`${this.prefix}-${e}`:e}setItem(e,t){this.storage.setItem(this.prefixKey(e),JSON.stringify(t))}getItem(e,t){const i=this.storage.getItem(this.prefixKey(e));return null!==i?JSON.parse(i):t||null}removeItem(e){this.storage.removeItem(this.prefixKey(e))}}class WidgetStorage{constructor(e){__publicField(this,"storage"),this.storage=e}getState(e){return this.storage.getItem(`widget-${e}`,{closed:!1,filled:!1,id:e,views:0,lastViewDate:+new Date})}updateState(e,t){this.storage.setItem(`widget-${e}`,{...this.getState(e),...t})}addView(e){this.updateState(e,{views:this.getState(e).views+1,filled:!1,lastViewDate:+new Date})}}class MigrationService{constructor(e){this.storage=e}migrateCyclicRules(e){e.forEach((e=>{void 0===this.storage.getState(e.id).lastViewDate&&this.storage.updateState(e.id,{lastViewDate:+new Date("2022")})}))}}class LangWatcher extends Subject{constructor(e){super(),__publicField(this,"state"),this.browser=e,this.state={code:this.browser.getLang()}}updateState(e){this.state=e.lang,this.notify(this.state)}getState(){return this.state}}class LangHandler{constructor(e,t){this.langWatcher=e,this.widgetManager=t}setup(){this.subscribeProviders()}subscribeProviders(){this.langWatcher.subscribe((e=>{this.notifyWidgetAboutLang(e)}))}notifyWidgetAboutLang(e){this.widgetManager.sendToAll({type:"SET_LANG",payload:e},[])}}const getDisplayRulesGuard=()=>getService("DisplayRulesGuard",(()=>new DisplayRulesGuard(getBrowserWatcher(),new CustomIntervalWatcher,getAttributesWatcher(),getWidgetStorage()))),getMessagesHandler=()=>getService("MessagesHandler",(()=>new MessagesHandler(getWidgetManager(),getWidgetStorage(),getBrowser()))),getAttributesHandler=()=>getService("AttributesHandler",(()=>new AttributesHandler(getAttributesWatcher(),getWidgetManager()))),getLangHandler=()=>getService("LangHandler",(()=>new LangHandler(getLangWatcher(),getWidgetManager()))),getBrowserWatcher=()=>getService("BrowserWatcher",(()=>new BrowserWatcher(getUserSession(),getBrowser(),getBindManager()))),getAttributesWatcher=()=>getService("AttributesWatcher",(()=>new AttributesWatcher)),getLangWatcher=()=>getService("LangWatcher",(()=>new LangWatcher(getBrowser()))),getBindManager=()=>{const e=getConfiguration();return getService("BindManager",(()=>new BindManager(getBrowser(),{cookieChangeDelay:e.cookieChangeDelay,locationChangeDelay:e.locationChangeDelay,scrollDelay:e.scrollDelay,timeDelay:e.timeDelay})))},getAggregatedStorage=()=>{const e=getConfiguration();return getService("AggregatedStorage",(()=>new AggregatedStorage(new BrowserStorage,new CookieStorage(getBrowser(),e.storageCookieLifeTimeInDays))))},getStorage=()=>{const e=getConfiguration();switch(e.storageType){case"localStorage":return new BrowserStorage;case"cookies":return new CookieStorage(getBrowser(),e.storageCookieLifeTimeInDays);case"both":return getAggregatedStorage();default:throw new Error("Invalid storage type.")}},getUserSession=()=>{const e=getConfiguration();return getService("UserSession",(()=>new UserSession({sessionKey:e.sessionKey,expandSessionIntervalInSeconds:e.expandSessionIntervalInSeconds,sessionTimeInMinutes:e.sessionTimeInMinutes},new StorageWrapper(e.storagePrefix,getStorage()))))},getWidgetStorage=()=>{const e=getConfiguration();return getService("WidgetStorage",(()=>new WidgetStorage(new StorageWrapper(e.storagePrefix,getStorage()))))},getMigrationService=()=>getService("MigrationService",(()=>new MigrationService(getWidgetStorage()))),bindInstallationVerification=(e,t)=>{window.addEventListener("message",(i=>{t.includes(new URL(i.origin).hostname)&&(!i.data||"INSTALLATION_VERIFICATION"===i.data.type&&i.data.payload.key===e)&&(document.documentElement.insertAdjacentHTML("afterbegin",getBanner(i.data.payload.bannerContent)),i.source instanceof MessagePort||i.source instanceof ServiceWorker||i.source.postMessage({type:"INSTALLATION_VERIFICATION_SUCCESS",payload:{key:e}},i.origin))}))},getBanner=e=>`<div style="background: #F0FAF0; color: #324D5A; font-size: 14px; font-family:'Open Sans', sans-serif; box-shadow: 0 1px 0 #BCE88E;width: 100vw;text-align: center;z-index: 10000000;position: fixed;padding: 20px; box-sizing: border-box"><svg style="margin-right: 10px; margin-bottom: -3px;" fill="none" height="18" viewBox="0 0 18 18" width="18" xmlns="http://www.w3.org/2000/svg"><path clip-rule="evenodd" d="m1.6875 0c-.44755 0-.876775.17779-1.193243.494257-.316467.316468-.494257.745693-.494257 1.193243v2.25 10.125c0 .4476.17779.8768.494257 1.1932.316467.3165.745693.4943 1.193243.4943h4.5c.31066 0 .5625-.2518.5625-.5625s-.25184-.5625-.5625-.5625h-4.5c-.14918 0-.29226-.0593-.39775-.1648-.10549-.1054-.16475-.2485-.16475-.3977v-9.5625h14.625v2.8125c0 .31066.2518.5625.5625.5625s.5625-.25184.5625-.5625v-3.375-2.25c0-.44755-.1778-.876776-.4943-1.193243-.3164-.316467-.7456-.494257-1.1932-.494257zm14.0625 3.375v-1.6875c0-.14918-.0593-.29226-.1648-.39775-.1054-.10549-.2485-.16475-.3977-.16475h-13.5c-.14918 0-.29226.05926-.39775.16475s-.16475.24857-.16475.39775v1.6875zm-2.8125 5.625c-.7788 0-1.54.23093-2.1876.66359-.6475.43261-1.15215 1.04761-1.45017 1.76711s-.376 1.5112-.22407 2.275.52694 1.4654 1.07764 2.016c.5506.5507 1.2522.9257 2.016 1.0776.7638.152 1.5555.074 2.275-.224s1.3345-.8027 1.7671-1.4502c.4327-.6476.6636-1.4088.6636-2.1876 0-.3107.2518-.5625.5625-.5625s.5625.2518.5625.5625c0 1.0013-.2969 1.9801-.8532 2.8126s-1.3469 1.4814-2.272 1.8645c-.925.3832-1.9429.4835-2.9249.2881-.9821-.1953-1.8841-.6775-2.59213-1.3855-.708-.708-1.19016-1.61-1.38549-2.5921-.19534-.982-.09509-1.9999.28808-2.9249.38317-.9251 1.03204-1.71574 1.86454-2.27202.8326-.55627 1.8113-.85318 2.8126-.85318.3107 0 .5625.25184.5625.5625s-.2518.5625-.5625.5625zm4.8977.96025c.2197-.21967.2197-.57583 0-.7955-.2196-.21967-.5758-.21967-.7954 0l-4.1027 4.10265-1.2889-1.2919c-.2194-.22-.5756-.2204-.7955-.001-.2199.2195-.2203.5756-.0009.7955l1.2896 1.2926c.1044.1046.2285.1875.365.2441.1366.0566.2829.0857.4307.0857s.2942-.0291.4307-.0857.2606-.1396.3651-.2441z" fill="#42b911" fill-rule="evenodd"/></svg>${e}</div>`,fetchConfiguration=(e,t)=>new Promise((i=>{const n=new XMLHttpRequest;n.responseType="json",n.onload=()=>{i(n.response.data)},n.open("GET",`${e}/widget-filling/configuration/${t}`,!0),n.send(null)})),init=e=>{setConfiguration(e),setConfiguration$1({nonce:e.nonce});const t=getDisplayRulesGuard(),i=getAppContainer(),n=getWidgetManager(),s=getMessagesHandler(),r=getAttributesHandler(),a=getLangHandler(),o=getAttributesWatcher(),c=getLangWatcher(),l=getConfiguration(),g=getMigrationService();bindInstallationVerification(l.key,l.installationVerificationHosts),document.body.contains(i)||document.body.append(i),s.setup(),r.setup(),a.setup(),t.subscribe((e=>{const t=e.map((e=>({id:e,template:getTemplate(l.widgetAppUrl,{apiUrl:l.apiUrl,nonce:l.nonce,widgetId:e,attributes:o.getState(e),lang:c.getState()})})));n.init(t)})),fetchConfiguration(l.apiUrl,l.key).then((e=>(g.migrateCyclicRules(e),t.watch(e),null))).catch((e=>{throw new Error(`Error fetching widgets configuration: ${e.message}`)}))};let isLoaded=!1;const Library={invoked:!0,queue:[],call:e=>{switch(e.type){case"load":{if(isLoaded)throw new Error("Library is already loaded.");const t=e.config.api||"https://app.startquestion.com",i=e.config.storageType||"both";fetch(`${t}/widget-filling/instance-configuration`).then((e=>e.json())).then((({data:n})=>{isLoaded=!0,init({key:e.config.key,nonce:e.config.nonce,apiUrl:t,storageType:i,widgetAppUrl:n.applicationUrl,installationVerificationHosts:n.verificationHosts})})).catch((()=>{}));break}case"setAttributes":getAttributesWatcher().updateState({attributes:Array.isArray(e.attributes)?{}:e.attributes||{},widgetId:Array.isArray(e.widgetId)?e.widgetId.map(convertToNumber):convertToNumber(e.widgetId)});break;case"refresh":if(Array.isArray(e.widgetId)){e.widgetId.forEach((e=>refresh(e)));break}refresh(e.widgetId);break;case"setLang":getLangWatcher().updateState({lang:{code:e.lang}});break;default:throw new Error("Passed operation is not supported.")}}};window.Startquestion&&window.Startquestion.queue&&window.Startquestion.queue.forEach((e=>{Library.call(e[0])})),window.Startquestion=Library})();
